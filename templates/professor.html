<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>PROF-SAFE 24 - App do Professor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg: #020617;
        }
        * { box-sizing:border-box; }
        body {
            margin:0;
            font-family: Arial, sans-serif;
            background: radial-gradient(circle at top left, #0f172a 0, #020617 55%, #000 100%);
            color:#e5e7eb;
            min-height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .shell {
            width:100%;
            max-width:540px;
            background:rgba(2,8,23,0.96);
            border-radius:20px;
            border:1px solid rgba(56,189,248,0.35);
            box-shadow:0 22px 60px rgba(0,0,0,0.9);
            padding:16px 16px 18px;
            position:relative;
            overflow:hidden;
        }
        .shell::before{
            content:"";
            position:absolute;
            inset:-40%;
            background:
                radial-gradient(circle at 0 0, rgba(56,189,248,0.16), transparent 55%),
                radial-gradient(circle at 100% 0, rgba(59,130,246,0.2), transparent 55%);
            opacity:0.9;
            pointer-events:none;
        }
        .shell-inner{
            position:relative;
            z-index:1;
        }
        header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:14px;
        }
        .brand{
            display:flex;
            align-items:center;
            gap:8px;
        }
        .brand-icon{
            width:36px;
            height:36px;
            border-radius:14px;
            background:radial-gradient(circle at 30% 0, #facc15, #e11d48 45%, #0f172a 100%);
            box-shadow:0 0 26px rgba(248,250,252,0.5);
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:10px;
            font-weight:bold;
            color:#f9fafb;
            letter-spacing:0.08em;
        }
        .brand-text-title{
            font-size:16px;
            font-weight:600;
            letter-spacing:0.08em;
            text-transform:uppercase;
            color:#e5e7eb;
        }
        .brand-text-sub{
            font-size:11px;
            color:#9ca3af;
        }
        .status-area{
            text-align:right;
            font-size:11px;
            color:#9ca3af;
        }
        .pill-online{
            font-size:11px;
            padding:3px 9px;
            border-radius:999px;
            border:1px solid #22c55e;
            color:#bbf7d0;
            background:rgba(6,95,70,0.7);
            display:inline-flex;
            gap:4px;
            align-items:center;
        }
        .clock{
            margin-top:4px;
            font-size:11px;
            color:#facc15;
            font-weight:bold;
        }
        main{
            background:radial-gradient(circle at top, rgba(15,23,42,0.92), rgba(15,23,42,0.98));
            border-radius:16px;
            border:1px solid rgba(148,163,184,0.45);
            box-shadow:0 16px 40px rgba(15,23,42,0.9);
            padding:12px 14px 14px;
            font-size:12px;
        }
        .intro{
            margin-bottom:10px;
            color:#cbd5f5;
            font-size:12px;
        }
        .intro strong{
            color:#e5e7eb;
        }
        .form-group{
            margin-bottom:10px;
        }
        label{
            display:block;
            font-size:11px;
            margin-bottom:3px;
            color:#cbd5f5;
        }
        input, textarea{
            width:100%;
            padding:7px 9px;
            border-radius:10px;
            border:1px solid rgba(148,163,184,0.9);
            background:rgba(15,23,42,0.98);
            color:#e5e7eb;
            font-size:13px;
        }
        textarea{
            resize:vertical;
            min-height:70px;
        }
        input:focus, textarea:focus{
            outline:none;
            border-color:#22d3ee;
            box-shadow:0 0 0 1px rgba(34,211,238,0.6);
        }
        .btn-alert{
            width:100%;
            border-radius:999px;
            border:none;
            padding:9px 0;
            margin-top:6px;
            background:linear-gradient(135deg,#f97316,#b91c1c);
            color:#f9fafb;
            font-size:14px;
            font-weight:700;
            letter-spacing:0.04em;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            box-shadow:0 16px 40px rgba(127,29,29,0.95);
        }
        .btn-alert span.icon{
            font-size:18px;
        }
        .btn-alert:active{
            transform:translateY(1px);
            box-shadow:0 8px 26px rgba(127,29,29,0.9);
        }
        .actions-row{
            display:flex;
            flex-wrap:wrap;
            gap:8px;
            margin-top:8px;
        }
        .btn-secondary{
            flex:1;
            min-width:90px;
            border-radius:999px;
            border:1px solid rgba(148,163,184,0.9);
            background:rgba(15,23,42,0.96);
            color:#e5e7eb;
            font-size:11px;
            padding:7px 10px;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
        }
        .btn-secondary:hover{
            filter:brightness(1.05);
        }
        .tip{
            margin-top:8px;
            font-size:11px;
            color:#9ca3af;
        }
        .tip strong{
            color:#e5e7eb;
        }
        .feedback{
            margin-top:6px;
            font-size:11px;
            color:#bbf7d0;
            display:none;
        }
        .logo-banner {
            display:flex;
            justify-content:flex-start;
            align-items:center;
            margin: 4px 0 12px;
        }
        .logo-banner img {
            max-width: 140px;
            width: 100%;
            height:auto;
            filter: drop-shadow(0 0 25px rgba(34,211,238,0.6));
            /* NOVO: Cantos arredondados na logo */
            border-radius: 12px;
        }

        /* NOVOS ESTILOS */
        .quick-alerts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        .quick-alert-btn {
            padding: 10px 8px;
            border-radius: 10px;
            border: 1px solid rgba(148,163,184,0.5);
            background: rgba(15,23,42,0.8);
            color: #e5e7eb;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.2s;
        }
        .quick-alert-btn:hover {
            background: rgba(30,41,59,0.8);
            border-color: rgba(56,189,248,0.5);
        }
        .quick-alert-btn.active {
            background: rgba(59,130,246,0.2);
            border-color: rgba(56,189,248,0.8);
            box-shadow: 0 0 10px rgba(56,189,248,0.3);
        }
        .quick-alert-icon {
            font-size: 18px;
        }
        .location-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            font-size: 11px;
            color: #9ca3af;
        }
        .location-info span {
            color: #facc15;
        }
        .emergency-level {
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .emergency-level label {
            margin-bottom: 6px;
        }
        .level-buttons {
            display: flex;
            gap: 6px;
        }
        .level-btn {
            flex: 1;
            padding: 6px;
            border-radius: 8px;
            border: 1px solid rgba(148,163,184,0.5);
            background: rgba(15,23,42,0.8);
            color: #e5e7eb;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
        }
        .level-btn.active {
            border-color: #f97316;
            background: rgba(249,115,22,0.2);
        }
        .level-btn.high.active {
            border-color: #dc2626;
            background: rgba(220,38,38,0.2);
        }
        .teacher-preferences {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 11px;
            color: #9ca3af;
        }
        .teacher-preferences input {
            width: auto;
            margin-right: 4px;
        }
        .auto-save-notice {
            font-size: 10px;
            color: #22c55e;
            margin-top: 4px;
            display: none;
        }

        @media (max-width:520px){
            .shell{
                margin:12px;
                padding:14px;
            }
            header{
                flex-direction:column;
                align-items:flex-start;
                gap:6px;
            }
            .status-area{
                text-align:left;
            }
            main{
                padding:10px 10px 12px;
            }
            .quick-alerts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="shell">
    <div class="logo-banner">
        <img src="{{ url_for('static', filename='logo_prof_safe24.png') }}" alt="PROF-SAFE 24">
    </div>
    <div class="shell-inner">
        <header>
            <div class="brand">
                <div class="brand-icon">PS24</div>
                <div>
                    <div class="brand-text-title">PROF-SAFE 24</div>
                    <div class="brand-text-sub">Prote√ß√£o inteligente 24h para quem ensina</div>
                </div>
            </div>
            <div class="status-area">
                <div class="pill-online">‚óè Conectado √† Central</div>
                <div class="clock" id="clockProf"></div>
            </div>
        </header>

        <main>
            <p class="intro">
                <strong>Envie um alerta r√°pido</strong> em caso de emerg√™ncia ou situa√ß√£o de risco.
            </p>

            <!-- Bot√µes de alerta r√°pido -->
            <div class="quick-alerts">
                <button class="quick-alert-btn" data-type="briga">
                    <span class="quick-alert-icon">üë•</span>
                    <span>Conflito/Briga</span>
                </button>
                <button class="quick-alert-btn" data-type="saude">
                    <span class="quick-alert-icon">ü§í</span>
                    <span>Problema de Sa√∫de</span>
                </button>
                <button class="quick-alert-btn" data-type="suspeito">
                    <span class="quick-alert-icon">üö∑</span>
                    <span>Pessoa Suspeita</span>
                </button>
                <button class="quick-alert-btn" data-type="outro">
                    <span class="quick-alert-icon">‚ö†Ô∏è</span>
                    <span>Outra Situa√ß√£o</span>
                </button>
            </div>

            <form id="alertForm">
                <div class="form-group">
                    <label for="teacher">Seu nome (opcional)</label>
                    <input type="text" id="teacher" name="teacher" placeholder="Ex.: Prof. Ana, Prof. Jo√£o">
                </div>
                <div class="form-group">
                    <label for="room">Sala / Local *</label>
                    <input type="text" id="room" name="room" required placeholder="Ex.: 5¬∫ A, P√°tio, Corredor 2">
                    <div class="location-info">
                        üìç <span id="locationStatus">Detectando localiza√ß√£o...</span>
                    </div>
                </div>
                
                <div class="emergency-level">
                    <label>N√≠vel de urg√™ncia</label>
                    <div class="level-buttons">
                        <button type="button" class="level-btn" data-level="baixa">Baixa</button>
                        <button type="button" class="level-btn active" data-level="media">M√©dia</button>
                        <button type="button" class="level-btn high" data-level="alta">Alta</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Descreva rapidamente o que est√° acontecendo *</label>
                    <textarea id="description" name="description" required placeholder="Ex.: briga entre alunos, aluno passando mal, pessoa suspeita no port√£o..."></textarea>
                </div>

                <button type="submit" class="btn-alert" id="btnAlert">
                    <span class="icon">üö®</span>
                    ENVIAR ALERTA PARA A CENTRAL
                </button>

                <div class="actions-row">
                    <button type="button" class="btn-secondary" id="btnReiniciar">‚ü≥ Reiniciar</button>
                    <button type="button" class="btn-secondary" id="btnLimpar">üßπ Limpar</button>
                    <button type="button" class="btn-secondary" id="btnSair">‚èª Sair</button>
                </div>
            </form>

            <div class="teacher-preferences">
                <input type="checkbox" id="savePreferences">
                <label for="savePreferences">Salvar meus dados para pr√≥ximos alertas</label>
            </div>
            <div class="auto-save-notice" id="autoSaveNotice">‚úì Dados salvos automaticamente</div>

            <div class="feedback" id="feedbackMsg">
                Alerta enviado com sucesso √† Central. Aguarde o retorno da equipe.
            </div>

            <p class="tip">
                <strong>Dica:</strong> mantenha este atalho salvo na tela inicial do seu celular para acesso mais r√°pido.
            </p>
        </main>
    </div>
</div>

<script>
const form = document.getElementById('alertForm');
const feedback = document.getElementById('feedbackMsg');
const btnAlert = document.getElementById('btnAlert');
const btnReiniciar = document.getElementById('btnReiniciar');
const btnLimpar = document.getElementById('btnLimpar');
const btnSair = document.getElementById('btnSair');
const quickAlertBtns = document.querySelectorAll('.quick-alert-btn');
const levelBtns = document.querySelectorAll('.level-btn');
const locationStatus = document.getElementById('locationStatus');
const savePreferences = document.getElementById('savePreferences');
const autoSaveNotice = document.getElementById('autoSaveNotice');

// CORRE√á√ÉO: Carregar prefer√™ncias salvas automaticamente
function loadPreferences() {
    const savedTeacher = localStorage.getItem('profSafeTeacher');
    const savedRoom = localStorage.getItem('profSafeRoom');
    const savedAutoSave = localStorage.getItem('profSafeAutoSave');
    
    if (savedTeacher) {
        document.getElementById('teacher').value = savedTeacher;
    }
    
    if (savedRoom) {
        document.getElementById('room').value = savedRoom;
    }
    
    // Marcar checkbox se j√° estava salvo
    if (savedAutoSave === 'true') {
        savePreferences.checked = true;
        autoSaveNotice.style.display = 'block';
    }
}

// CORRE√á√ÉO: Salvar prefer√™ncias automaticamente quando os campos mudam
function setupAutoSave() {
    const teacherField = document.getElementById('teacher');
    const roomField = document.getElementById('room');
    
    teacherField.addEventListener('input', saveUserPreferences);
    roomField.addEventListener('input', saveUserPreferences);
    
    // Salvar quando o checkbox for alterado
    savePreferences.addEventListener('change', function() {
        if (this.checked) {
            saveUserPreferences();
            autoSaveNotice.style.display = 'block';
            // Salvar a prefer√™ncia de auto-save
            localStorage.setItem('profSafeAutoSave', 'true');
        } else {
            autoSaveNotice.style.display = 'none';
            // Remover a prefer√™ncia de auto-save
            localStorage.setItem('profSafeAutoSave', 'false');
        }
    });
}

// CORRE√á√ÉO: Fun√ß√£o melhorada para salvar prefer√™ncias
function saveUserPreferences() {
    const teacher = document.getElementById('teacher').value;
    const room = document.getElementById('room').value;
    
    // Salvar apenas se o checkbox estiver marcado
    if (savePreferences.checked && (teacher || room)) {
        localStorage.setItem('profSafeTeacher', teacher);
        localStorage.setItem('profSafeRoom', room);
        localStorage.setItem('profSafeAutoSave', 'true');
        
        // Mostrar feedback visual
        autoSaveNotice.style.display = 'block';
        setTimeout(() => {
            autoSaveNotice.style.display = 'none';
        }, 2000);
    }
}

// Obter localiza√ß√£o
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                locationStatus.textContent = `Localiza√ß√£o obtida (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
            },
            error => {
                console.error("Erro ao obter localiza√ß√£o:", error);
                locationStatus.textContent = "Localiza√ß√£o n√£o dispon√≠vel";
            }
        );
    } else {
        locationStatus.textContent = "Geolocaliza√ß√£o n√£o suportada";
    }
}

// Configurar bot√µes de alerta r√°pido
quickAlertBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        // Remover classe active de todos os bot√µes
        quickAlertBtns.forEach(b => b.classList.remove('active'));
        // Adicionar classe active ao bot√£o clicado
        btn.classList.add('active');
        
        // Preencher descri√ß√£o baseada no tipo
        const type = btn.getAttribute('data-type');
        const descriptionField = document.getElementById('description');
        
        switch(type) {
            case 'briga':
                descriptionField.value = "Conflito ou briga entre alunos";
                break;
            case 'saude':
                descriptionField.value = "Problema de sa√∫de com aluno/funcion√°rio";
                break;
            case 'suspeito':
                descriptionField.value = "Pessoa suspeita nas depend√™ncias da escola";
                break;
            case 'outro':
                descriptionField.value = "";
                descriptionField.focus();
                break;
        }
    });
});

// Configurar bot√µes de n√≠vel de urg√™ncia
levelBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        levelBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    });
});

// Envio do formul√°rio
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const teacher = document.getElementById('teacher').value;
    const room = document.getElementById('room').value;
    const description = document.getElementById('description').value;
    
    // Obter n√≠vel de urg√™ncia selecionado
    const activeLevelBtn = document.querySelector('.level-btn.active');
    const urgencyLevel = activeLevelBtn ? activeLevelBtn.getAttribute('data-level') : 'media';

    if(!room || !description){
        alert('Por favor, preencha Sala/Local e Descri√ß√£o.');
        return;
    }

    const originalLabel = btnAlert.innerHTML;
    btnAlert.disabled = true;
    btnAlert.innerHTML = 'Enviando...';

    try{
        const res = await fetch('/api/alert', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                teacher, 
                room, 
                description,
                urgencyLevel,
                timestamp: new Date().toISOString()
            })
        });
        const data = await res.json();
        if(data.ok){
            feedback.style.display = 'block';
            
            // Salvar prefer√™ncias se solicitado
            saveUserPreferences();
            
            // Limpar formul√°rio ap√≥s envio bem-sucedido
            setTimeout(() => {
                form.reset();
                quickAlertBtns.forEach(btn => btn.classList.remove('active'));
                levelBtns[1].classList.add('active'); // Reset para n√≠vel m√©dio
                feedback.style.display = 'none';
            }, 4000);
        }else{
            alert('N√£o foi poss√≠vel enviar o alerta. Tente novamente.');
        }
    }catch(e){
        console.error(e);
        alert('Erro de comunica√ß√£o com a Central. Verifique a conex√£o.');
    }finally{
        btnAlert.disabled = false;
        btnAlert.innerHTML = originalLabel;
    }
});

// Bot√£o LIMPAR: limpa os campos e esconde a mensagem
btnLimpar.addEventListener('click', () => {
    form.reset();
    quickAlertBtns.forEach(btn => btn.classList.remove('active'));
    levelBtns[1].classList.add('active'); // Reset para n√≠vel m√©dio
    feedback.style.display = 'none';
    autoSaveNotice.style.display = 'none';
});

// Bot√£o REINICIAR: recarrega a p√°gina
btnReiniciar.addEventListener('click', () => {
    location.reload();
});

// Bot√£o SAIR: volta para a tela inicial
btnSair.addEventListener('click', () => {
    window.location.href = '/';
});

// Inicializa√ß√£o
function init() {
    loadPreferences();
    setupAutoSave(); // CORRE√á√ÉO: Configurar auto-save
    getLocation();
    updateClockProf();
}

function updateClockProf(){
    const el = document.getElementById('clockProf');
    const now = new Date();
    el.textContent = now.toLocaleTimeString('pt-BR',{hour12:false});
}

setInterval(updateClockProf,1000);
init();
</script>
</body>
</html>
