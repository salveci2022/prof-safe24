<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>PROF-SAFE 24 - Professor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        /* üåô MANTIDO EXATAMENTE IGUAL ‚Äî NADA VISUAL MUDOU */
        :root { --bg: #020617; }
        * { box-sizing:border-box; }
        body {
            margin:0;
            font-family: Arial, sans-serif;
            background: radial-gradient(circle at top left, #0f172a 0, #020617 55%, #000 100%);
            color:#e5e7eb;
            min-height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .shell {
            width:100%;
            max-width:540px;
            background:rgba(2,8,23,0.96);
            border-radius:20px;
            border:1px solid rgba(56,189,248,0.35);
            box-shadow:0 22px 60px rgba(0,0,0,0.9);
            padding:16px;
            position:relative;
            overflow:hidden;
        }
        .shell-inner { position:relative; z-index:1; }
        .logo-banner {
            display:flex;
            justify-content:flex-start;
            margin-bottom:12px;
        }
        .logo-banner img {
            max-width:140px;
            height:auto;
            filter:drop-shadow(0 0 16px rgba(34,211,238,0.5));
        }
        header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:14px;
        }
        .brand { display:flex; align-items:center; gap:8px; }
        .brand-icon {
            width:36px; height:36px;
            border-radius:14px;
            background:radial-gradient(circle at 30% 0, #facc15, #e11d48 45%, #0f172a 100%);
            display:flex; align-items:center; justify-content:center;
            font-size:10px; color:#fff; font-weight:bold;
        }
        main {
            background:rgba(15,23,42,0.96);
            border-radius:16px;
            padding:14px;
            border:1px solid rgba(148,163,184,0.45);
        }
        label { font-size:11px; margin-bottom:3px; display:block; }
        input, textarea {
            width:100%; padding:7px; border-radius:10px;
            background:rgba(15,23,42,0.98);
            border:1px solid rgba(148,163,184,0.9);
            color:#e5e7eb;
        }
        textarea { min-height:70px; resize:vertical; }

        .btn-alert {
            margin-top:8px;
            width:100%;
            padding:9px 0;
            border-radius:999px;
            background:linear-gradient(135deg,#f97316,#b91c1c);
            color:#fff;
            font-weight:bold;
            cursor:pointer;
            display:flex; justify-content:center; gap:6px;
        }
        .actions-row {
            display:flex;
            gap:8px;
            margin-top:10px;
        }
        .btn-secondary {
            flex:1;
            padding:7px;
            font-size:11px;
            border-radius:999px;
            background:rgba(15,23,42,0.96);
            border:1px solid rgba(148,163,184,0.9);
            color:#e5e7eb;
            cursor:pointer;
        }
        .feedback {
            margin-top:6px;
            font-size:12px;
            color:#bbf7d0;
            display:none;
        }
        #cancelBox {
            display:none;
            margin-top:10px;
            padding:6px;
            text-align:center;
            color:#fca5a5;
            background:rgba(100,20,20,0.4);
            border:1px solid rgba(255,80,80,0.6);
            border-radius:8px;
        }
    </style>
</head>

<body>
<div class="shell">

    <div class="logo-banner">
        <img src="{{ url_for('static', filename='logo_prof_safe24.png') }}">
    </div>

    <div class="shell-inner">
        <header>
            <div class="brand">
                <div class="brand-icon">PS24</div>
                <div>
                    <div style="font-size:16px;font-weight:600;">PROF-SAFE 24</div>
                    <div style="font-size:11px;color:#9ca3af;">Prote√ß√£o inteligente</div>
                </div>
            </div>

            <div style="font-size:12px;color:#facc15;" id="clockProf"></div>
        </header>

        <main>
            <form id="alertForm">

                <label>Sala / Local *</label>
                <input id="room">

                <label>Descri√ß√£o *</label>
                <textarea id="description"></textarea>

                <button type="submit" class="btn-alert" id="btnAlert">
                    üö® ENVIAR ALERTA PARA A CENTRAL
                </button>

                <div class="actions-row">
                    <button type="button" class="btn-secondary" id="btnReiniciar">‚ü≥ Reiniciar</button>
                    <button type="button" class="btn-secondary" id="btnLimpar">üßπ Limpar</button>
                    <button type="button" class="btn-secondary" id="btnSair">‚èª Sair</button>
                </div>
            </form>

            <div class="feedback" id="feedbackMsg">Alerta enviado.</div>
            <div id="cancelBox">Cancelar alerta ( <span id="timer">5</span>s )</div>
        </main>
    </div>
</div>

<script>
/* ============================== */
/*     FUN√á√ïES INTERNAS ULTRA     */
/* ============================== */

/* Rel√≥gio */
function updateClockProf(){
    document.getElementById("clockProf").textContent =
        new Date().toLocaleTimeString("pt-BR",{hour12:false});
}
setInterval(updateClockProf,1000); updateClockProf();

/* Sala autom√°tica */
const roomField = document.getElementById("room");
const savedRoom = localStorage.getItem("prof_room");
if(savedRoom){ roomField.value = savedRoom; }

/* Sugest√£o inteligente da descri√ß√£o */
const desc = document.getElementById("description");
desc.addEventListener("input", ()=>{
    const v = desc.value.toLowerCase();
    if(v==="b") desc.value="Briga entre alunos";
    if(v==="m") desc.value="Aluno passando mal";
    if(v==="s") desc.value="Pessoa suspeita no corredor";
});

/* ENVIAR √ÅUDIO (5s) ‚Äì invis√≠vel */
async function gravarAudio(){
    try{
        let stream = await navigator.mediaDevices.getUserMedia({audio:true});
        let media = new MediaRecorder(stream);
        let chunks = [];

        return new Promise(resolve=>{
            media.ondataavailable=e=>chunks.push(e.data);
            media.onstop=()=>resolve(new Blob(chunks,{type:'audio/webm'}));
            media.start();
            setTimeout(()=>media.stop(),5000);
        });

    }catch(e){
        return null;
    }
}

/* ALERTA COMPLETO */
const form = document.getElementById("alertForm");
const feedback = document.getElementById("feedbackMsg");
const cancelBox = document.getElementById("cancelBox");
let cancelTimer;

form.addEventListener("submit", async(e)=>{
    e.preventDefault();

    const room = roomField.value.trim() || savedRoom || "Sala n√£o informada";
    localStorage.setItem("prof_room", room);

    const description = desc.value.trim() || "Emerg√™ncia";

    document.getElementById("btnAlert").disabled = true;
    document.getElementById("btnAlert").textContent = "Enviando‚Ä¶";

    /* GRAVAR √ÅUDIO AUTOMATICAMENTE */
    let audioBlob = await gravarAudio();

    let formData = new FormData();
    formData.append("room", room);
    formData.append("description", description);
    if(audioBlob) formData.append("audio", audioBlob, "alerta.webm");

    await fetch("/api/alert_full", {
        method:"POST",
        body:formData
    });

    feedback.style.display="block";
    form.reset();

    /* CANCELAR ALERTA */
    cancelBox.style.display="block";
    let t=5;
    document.getElementById("timer").textContent=t;
    cancelTimer=setInterval(()=>{
        t--;
        document.getElementById("timer").textContent=t;
        if(t<=0){
            clearInterval(cancelTimer);
            cancelBox.style.display="none";
        }
    },1000);

    setTimeout(()=>feedback.style.display="none",3200);

    document.getElementById("btnAlert").disabled = false;
    document.getElementById("btnAlert").textContent = "üö® ENVIAR ALERTA PARA A CENTRAL";
});

/* CANCELAR ALERTA */
cancelBox.onclick = ()=>{
    clearInterval(cancelTimer);
    cancelBox.style.display="none";
    fetch("/api/cancel", {method:"POST"});
};

/* LIMPAR / REINICIAR / SAIR */
document.getElementById("btnLimpar").onclick = ()=> form.reset();
document.getElementById("btnReiniciar").onclick = ()=> location.reload();
document.getElementById("btnSair").onclick = ()=> location.href="/";

/* ALERTA SILENCIOSO (segurar 2s) */
let pressTimer;
document.getElementById("btnAlert").addEventListener("mousedown", ()=>{
    pressTimer = setTimeout(()=>{
        fetch("/api/silent_alert",{method:"POST"});
        alert("‚ö†Ô∏è Alerta silencioso enviado");
    },2000);
});
document.getElementById("btnAlert").addEventListener("mouseup", ()=> clearTimeout(pressTimer));

</script>
</body>
</html>
