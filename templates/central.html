<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>PROF-SAFE 24 - Painel Central</title>
    <style>
        * { box-sizing:border-box; }
        body {
            margin:0;
            font-family: Arial, sans-serif;
            background: radial-gradient(circle at top left, #0f172a 0, #020617 55%, #000 100%);
            color:#e5e7eb;
        }
        .shell {
            max-width: 1200px;
            margin: 0 auto;
            padding: 18px 28px 32px;
        }
        header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:14px 20px;
            border-radius:18px;
            background: radial-gradient(circle at top left, #0b1120, #020617);
            box-shadow:0 18px 40px rgba(0,0,0,0.85);
            border:1px solid rgba(15,118,110,0.7);
            margin-bottom:18px;
        }
        .brand {
            display:flex;
            align-items:center;
            gap:12px;
        }
        .brand-icon {
            width:32px;
            height:32px;
            border-radius:999px;
            background:radial-gradient(circle at 30% 20%, #4ade80, #22c55e 35%, #064e3b 100%);
            box-shadow:0 0 20px rgba(34,197,94,0.8);
        }
        .brand-text-title {
            font-size:26px;
            font-weight:800;
            letter-spacing:0.08em;
        }
        .brand-text-sub {
            font-size:14px;
            color:#9ca3af;
        }
        .status-area {
            display:flex;
            align-items:center;
            gap:16px;
        }
        .pill-ready {
            font-size:12px;
            padding:4px 12px;
            border-radius:999px;
            border:1px solid #22c55e;
            color:#bbf7d0;
            background:rgba(6,95,70,0.7);
        }
        .clock {
            font-size:20px;
            color:#facc15;
            font-weight:800;
            letter-spacing:0.05em;
        }
        a.voltar {
            display:inline-block;
            margin:10px 0 4px;
            color:#22d3ee;
            font-size:13px;
            text-decoration:none;
        }
        .panel {
            margin-top:4px;
            border-radius:22px;
            background: radial-gradient(circle at top left, #020617, #020617 50%, #000 100%);
            border:1px solid rgba(15,23,42,0.9);
            padding:20px 22px 24px;
            box-shadow:0 20px 45px rgba(0,0,0,0.95);
        }
        .panel-title {
            font-size:20px;
            font-weight:bold;
            margin-bottom:4px;
        }
        .panel-sub {
            font-size:13px;
            color:#9ca3af;
            margin-bottom:18px;
        }
        .grid {
            display:grid;
            grid-template-columns: 1.1fr 1fr;
            gap:20px;
            align-items:flex-start;
        }
        .card {
            background:rgba(15,23,42,0.95);
            border-radius:18px;
            padding:18px;
            border:1px solid rgba(30,64,175,0.8);
            box-shadow:0 18px 40px rgba(0,0,0,0.9);
        }
        .card h2 {
            margin:0 0 10px;
            font-size:17px;
        }
        label {
            display:block;
            margin-top:6px;
            margin-bottom:3px;
            font-size:13px;
            color:#cbd5f5;
        }
        input, textarea {
            width:100%;
            padding:8px;
            background:#020617;
            color:#e5e7eb;
            border-radius:10px;
            border:1px solid #111827;
            font-size:14px;
        }
        textarea {
            min-height:60px;
            resize:vertical;
        }
        .btn-row {
            margin-top:10px;
            display:flex;
            flex-wrap:wrap;
            gap:10px;
        }
        button {
            padding:10px 14px;
            font-size:14px;
            border-radius:999px;
            border:none;
            cursor:pointer;
            font-weight:bold;
            color:#fff;
            box-shadow:0 0 20px rgba(0,0,0,0.9);
        }
        .btn-sirene { background:linear-gradient(135deg,#ff0040,#ff6a00); }
        .btn-teste { background:linear-gradient(135deg,#facc15,#eab308); color:#111827; }
        .btn-mute  { background:linear-gradient(135deg,#4b5563,#111827); }
        .btn-pdf   { background:linear-gradient(135deg,#0ea5e9,#2563eb); }
        .btn-sair  { background:linear-gradient(135deg,#334155,#020617); }
        .btn-resolver { background:linear-gradient(135deg,#16a34a,#22c55e); }
        .btn-limpar   { background:linear-gradient(135deg,#0ea5e9,#2563eb); }
        #sirenStatus {
            font-size:14px;
            margin-top:10px;
        }
        #lastUpdate {
            font-size:11px;
            color:#9ca3af;
            margin-top:4px;
        }
        .status-sphere-wrap {
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding-top:10px;
        }
        .sphere {
            width:160px;
            height:160px;
            border-radius:50%;
            background:radial-gradient(circle at 30% 20%, #22c55e, #16a34a 40%, #052e16 100%);
            box-shadow:0 0 40px rgba(34,197,94,0.8);
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:bold;
            letter-spacing:1px;
        }
        .sphere-label {
            margin-top:10px;
            font-size:14px;
        }
        .table-wrapper {
            margin-top:16px;
            max-height:250px;
            overflow:auto;
            border-radius:12px;
            border:1px solid #111827;
        }
        table {
            width:100%;
            border-collapse:collapse;
            font-size:12px;
        }
        th, td {
            padding:6px 8px;
            border-bottom:1px solid #111827;
        }
        th {
            background:#020617;
            position:sticky;
            top:0;
        }
        tr:nth-child(even) td { background:#020819; }
        .badge-ativo {
            color:#fff;
            background:#ef4444;
            padding:2px 6px;
            border-radius:999px;
            font-size:11px;
        }
        .badge-resolvido {
            color:#022c22;
            background:#22c55e;
            padding:2px 6px;
            border-radius:999px;
            font-size:11px;
        }
    </style>
</head>
<body>
<div class="shell">
    <header>
        <div class="brand">
            <div class="brand-icon"></div>
            <div>
                <div class="brand-text-title">PROF-SAFE 24</div>
                <div class="brand-text-sub">Prote√ß√£o inteligente 24h para quem ensina</div>
            </div>
        </div>
        <div class="status-area">
            <span class="pill-ready">‚óè Pronto</span>
            <span class="clock" id="clock"></span>
        </div>
    </header>

    <a href="/" class="voltar">‚¨Ö Voltar para o in√≠cio</a>

    <section class="panel">
        <div class="panel-title">Painel Central</div>
        <div class="panel-sub">Recebe alertas em tempo real. A luz vermelha pisca junto com a sirene.</div>

        <div class="grid">
            <!-- Coluna esquerda -->
            <div class="card">
                <h2>üìò Dados da Escola</h2>
                <label for="school_name">Nome da Escola</label>
                <input id="school_name" type="text" placeholder="Ex.: CEM 404 - Santa Maria">

                <label for="school_address">Endere√ßo</label>
                <input id="school_address" type="text" placeholder="Rua, n√∫mero, bairro, cidade...">

                <label for="school_director">Diretor(a)</label>
                <input id="school_director" type="text" placeholder="Nome do respons√°vel">

                <label for="school_phone">Telefone</label>
                <input id="school_phone" type="text" placeholder="Ex.: (61) 9 9999-9999">

                <label for="school_obs">Observa√ß√µes Gerais</label>
                <textarea id="school_obs" placeholder="Ex.: port√£o lateral, seguran√ßa terceirizada, hor√°rio de pico..."></textarea>

                <hr style="border-color:#111827; margin:14px 0;">

                <h2>üö® Controlo da Sirene</h2>
                <div class="btn-row">
                    <button class="btn-sirene" onclick="siren('on')">SIRENE MANUAL</button>
                    <button class="btn-teste" onclick="siren('on')">TESTE</button>
                    <button class="btn-pdf" onclick="window.open('/report.pdf','_blank')">BAIXAR PDF</button>
                </div>
                <div class="btn-row">
                    <button class="btn-mute" onclick="siren('off')">PARAR SIRENE</button>
                    <button class="btn-sair" onclick="window.location.href='/logout_central'">SAIR</button>
                </div>
                <div id="sirenStatus">Status da Sirene: <b>Desligada</b></div>
                <div id="lastUpdate"></div>

                <audio id="sirenAudio" loop>
                    <source src="/static/siren.wav" type="audio/wav">
                </audio>

                <hr style="border-color:#111827; margin:16px 0;">

                <h2>üß© Gest√£o de Alertas</h2>
                <div class="btn-row">
                    <button class="btn-resolver" onclick="resolverProximo()">RESOLVER</button>
                    <button class="btn-limpar" onclick="limparAlertas()">LIMPAR FEED</button>
                </div>
            </div>

            <!-- Coluna direita -->
            <div class="card">
                <div class="status-sphere-wrap">
                    <div id="sphere" class="sphere">NORMAL</div>
                    <div class="sphere-label">Estado do sistema</div>
                </div>

                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Professor(a)</th>
                                <th>Sala / Local</th>
                                <th>Descri√ß√£o</th>
                                <th>Data / Hora</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="alertsBody">
                            <tr>
                                <td colspan="6" style="text-align:center; padding:20px; color:#9ca3af;">
                                    Nenhum alerta recebido ainda...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
async function fetchStatus() {
    const resp = await fetch('/api/status');
    return await resp.json();
}

function renderAlerts(alerts) {
    const tbody = document.getElementById('alertsBody');
    tbody.innerHTML = '';
    if (!alerts || alerts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#9ca3af;">Nenhum alerta recebido ainda...</td></tr>';
        return;
    }
    alerts.forEach((a, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${a.teacher || '‚Äî'}</td>
            <td>${a.room || '‚Äî'}</td>
            <td>${a.description || '‚Äî'}</td>
            <td>${a.ts || '‚Äî'}</td>
            <td>${a.resolved ? '<span class="badge-resolvido">Resolvido</span>' : '<span class="badge-ativo">Ativo</span>'}</td>
        `;
        tbody.appendChild(tr);
    });
}

function updateVisualState(hasActive) {
    const sphere = document.getElementById('sphere');
    if (hasActive) {
        sphere.textContent = "ALERTA";
        sphere.style.background = "radial-gradient(circle at 30% 20%, #f97316, #ef4444 45%, #450a0a 100%)";
        sphere.style.boxShadow = "0 0 40px rgba(248,113,113,0.9)";
    } else {
        sphere.textContent = "NORMAL";
        sphere.style.background = "radial-gradient(circle at 30% 20%, #22c55e, #16a34a 40%, #052e16 100%)";
        sphere.style.boxShadow = "0 0 40px rgba(34,197,94,0.8)";
    }
}

function updateSirenUI(sirenOn, muted, alerts) {
    const sirenStatus = document.getElementById('sirenStatus');
    const audio = document.getElementById('sirenAudio');
    const hasActive = alerts && alerts.some(a => !a.resolved);

    updateVisualState(hasActive || sirenOn);

    if (sirenOn && !muted) {
        sirenStatus.innerHTML = 'Status da Sirene: <b style="color:#ef4444;">ATIVA</b>';
        if (audio.paused) {
            audio.currentTime = 0;
            audio.play().catch(()=>{});
        }
    } else if (sirenOn && muted) {
        sirenStatus.innerHTML = 'Status da Sirene: <b style="color:#fbbf24;">Ativa (Mudo)</b>';
        audio.pause();
        audio.currentTime = 0;
    } else {
        sirenStatus.innerHTML = 'Status da Sirene: <b>Desligada</b>';
        audio.pause();
        audio.currentTime = 0;
    }
}

async function atualizar() {
    try {
        const data = await fetchStatus();
        renderAlerts(data.alerts);
        updateSirenUI(data.siren, data.muted, data.alerts || []);
        const now = new Date();
        document.getElementById('lastUpdate').textContent =
            '√öltima atualiza√ß√£o: ' + now.toLocaleString('pt-BR');
    } catch(e) {
        console.error(e);
    }
}

async function siren(action) {
    try {
        const resp = await fetch('/api/siren', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action})
        });
        const data = await resp.json();
        // chamo atualizar para garantir estado correto da esfera e da sirene
        atualizar();
    } catch(e) {
        console.error(e);
    }
}

async function resolverProximo() {
    try {
        await fetch('/api/resolve', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        atualizar();
    } catch(e) {
        console.error(e);
    }
}

async function limparAlertas() {
    if (!confirm('Tem certeza que deseja limpar todos os alertas?')) return;
    try {
        await fetch('/api/clear', { method: 'POST' });
        atualizar();
    } catch(e) {
        console.error(e);
    }
}

function updateClock(){
    const el = document.getElementById('clock');
    const now = new Date();
    el.textContent = now.toLocaleTimeString('pt-BR',{hour12:false});
}
setInterval(updateClock,1000);
updateClock();

setInterval(atualizar, 5000);
atualizar();
</script>
</body>
</html>
