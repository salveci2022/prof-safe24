<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Central de Seguran√ßa ‚Äì PROF-SAFE 24</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #05050a;
            color: #f5f5f5;
            padding: 16px;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .title {
            font-size: 22px;
            font-weight: bold;
        }
        .subtitle {
            font-size: 12px;
            color: #bbbbbb;
        }
        .badge {
            background: #ff8800;
            color: #fff;
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: .08em;
        }
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 14px;
        }
        .card {
            background: #101018;
            border-radius: 12px;
            padding: 14px 14px 16px;
            box-shadow: 0 0 14px rgba(0,0,0,0.6);
        }
        .card h2 {
            font-size: 16px;
            margin-bottom: 4px;
        }
        .card small {
            font-size: 11px;
            color: #aaaaaa;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        th, td {
            padding: 7px 6px;
            border-bottom: 1px solid #262638;
            text-align: left;
        }
        th {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .05em;
            color: #bbbbbb;
        }
        .status-ativo { color: #ffb347; font-weight: bold; }
        .status-resolvido { color: #6be49a; font-weight: bold; }

        .btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .btn {
            border: none;
            border-radius: 999px;
            padding: 9px 16px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: #ff8800; color: #fff; }
        .btn-primary:hover { background: #e67600; }
        .btn-secondary { background: #262638; color: #f5f5f5; }
        .btn-secondary:hover { background: #33344a; }
        .tag-siren {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            margin-top: 8px;
        }
        .dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
        }
        .dot-on { background: #ff3b3b; box-shadow: 0 0 8px #ff3b3b; }
        .dot-off { background: #555; }
        .footer-note {
            margin-top: 12px;
            font-size: 11px;
            color: #aaaaaa;
        }

        @media (max-width: 900px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">

    <div class="topbar">
        <div>
            <div class="title">Central de Monitoramento ‚Äì PROF-SAFE 24</div>
            <div class="subtitle">Visualiza√ß√£o em tempo real dos alertas enviados pelos professores.</div>
        </div>
        <div class="badge">Central</div>
    </div>

    <div class="grid">
        <!-- Coluna esquerda: lista de alertas -->
        <div class="card">
            <h2>Alertas recebidos</h2>
            <small>Atualiza√ß√£o autom√°tica a cada 2 segundos.</small>

            <table>
                <thead>
                <tr>
                    <th>#</th>
                    <th>Professor</th>
                    <th>Sala/Local</th>
                    <th>Descri√ß√£o</th>
                    <th>Data/Hora</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody id="alerts-body">
                <tr><td colspan="6">Carregando alertas...</td></tr>
                </tbody>
            </table>

            <div class="btn-row" style="margin-top: 12px;">
                <button class="btn btn-primary" onclick="refreshStatus()">üîÑ Atualizar agora</button>
                <button class="btn btn-secondary" onclick="resolverPrimeiro()">‚úÖ Marcar primeiro como resolvido</button>
                <button class="btn btn-secondary" onclick="limparAlertas()">üßπ Limpar todos</button>
            </div>
        </div>

        <!-- Coluna direita: sirene + PDF + navega√ß√£o -->
        <div class="card">
            <h2>Sirene & Relat√≥rios</h2>
            <small>Controle de som e gera√ß√£o de relat√≥rio em PDF.</small>

            <div class="tag-siren">
                <span id="siren-dot" class="dot dot-off"></span>
                <span id="siren-text">Sirene desligada</span>
            </div>

            <div class="btn-row" style="margin-top: 12px;">
                <button class="btn btn-primary" onclick="sirenOn()">üö® Ligar sirene</button>
                <button class="btn btn-secondary" onclick="sirenMute()">üîá Silenciar</button>
                <button class="btn btn-secondary" onclick="sirenOff()">‚èª Desligar sirene</button>
            </div>

            <div class="btn-row" style="margin-top: 16px;">
                <a class="btn btn-primary" href="/report.pdf" target="_blank">üìÑ Abrir relat√≥rio em PDF</a>
                <a class="btn btn-secondary" href="/">üè† Tela inicial</a>
                <a class="btn btn-secondary" href="/admin/escola">üè´ Configurar escola</a>
            </div>

            <div class="footer-note">
                A sirene toca localmente nesta m√°quina quando houver alerta ativo.
                O relat√≥rio PDF inclui todos os alertas registrados.
            </div>
        </div>
    </div>
</div>

<!-- √Åudio da sirene (ajuste o caminho do arquivo conforme seu static) -->
<audio id="sirenAudio">
    <!-- Exemplo: coloque o arquivo em static/sounds/sirene.mp3 e troque abaixo -->
    <source src="/static/sounds/sirene.mp3" type="audio/mpeg">
</audio>

<script>
    let currentSiren = false;
    let currentMuted = false;

    async function refreshStatus() {
        try {
            const resp = await fetch("/api/status");
            const data = await resp.json();

            // Atualizar tabela
            const body = document.getElementById("alerts-body");
            body.innerHTML = "";

            if (!data.alerts || data.alerts.length === 0) {
                body.innerHTML = '<tr><td colspan="6">Nenhum alerta no momento.</td></tr>';
            } else {
                data.alerts.forEach((a, idx) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${idx + 1}</td>
                        <td>${a.teacher || '-'}</td>
                        <td>${a.room || '-'}</td>
                        <td>${a.description || '-'}</td>
                        <td>${a.ts || '-'}</td>
                        <td class="${a.resolved ? 'status-resolvido' : 'status-ativo'}">
                            ${a.resolved ? 'Resolvido' : 'Ativo'}
                        </td>
                    `;
                    body.appendChild(tr);
                });
            }

            // Atualizar estado da sirene
            currentSiren = data.siren;
            currentMuted = data.muted;

            const dot = document.getElementById("siren-dot");
            const text = document.getElementById("siren-text");
            const audio = document.getElementById("sirenAudio");

            if (currentSiren && !currentMuted) {
                dot.className = "dot dot-on";
                text.textContent = "Sirene ligada";
                if (audio && audio.paused) {
                    audio.loop = true;
                    audio.play().catch(() => {});
                }
            } else if (currentSiren && currentMuted) {
                dot.className = "dot dot-off";
                text.textContent = "Sirene em modo silencioso";
                if (audio && !audio.paused) audio.pause();
            } else {
                dot.className = "dot dot-off";
                text.textContent = "Sirene desligada";
                if (audio && !audio.paused) audio.pause();
            }

        } catch (e) {
            console.error("Erro ao atualizar status:", e);
        }
    }

    async function sirenOn() {
        await fetch("/api/siren", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({action: "on"})
        });
        refreshStatus();
    }

    async function sirenOff() {
        await fetch("/api/siren", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({action: "off"})
        });
        refreshStatus();
    }

    async function sirenMute() {
        await fetch("/api/siren", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({action: "mute"})
        });
        refreshStatus();
    }

    async function resolverPrimeiro() {
        await fetch("/api/resolve", {method: "POST"});
        refreshStatus();
    }

    async function limparAlertas() {
        if (!confirm("Tem certeza que deseja limpar TODOS os alertas?")) return;
        await fetch("/api/clear", {method: "POST"});
        refreshStatus();
    }

    // Atualiza√ß√£o autom√°tica
    setInterval(refreshStatus, 2000);
    window.addEventListener("load", refreshStatus);
</script>
</body>
</html>
