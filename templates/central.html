<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Central de Monitoramento ‚Äì PROF-SAFE 24</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: radial-gradient(circle at top, #1b1b2f 0, #050509 60%);
            color: #f5f5f5;
            padding: 18px;
        }
        .container {
            max-width: 980px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }
        .logo-wrap {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            overflow: hidden;
            border: 2px solid #ff8800;
            flex-shrink: 0;
        }
        .logo-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .title-block {
            flex: 1;
        }
        .title {
            font-size: 22px;
            font-weight: bold;
        }
        .subtitle {
            font-size: 12px;
            color: #c0c0c0;
        }
        .badge {
            font-size: 11px;
            padding: 5px 12px;
            border-radius: 999px;
            background: #ff8800;
            color: #111;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1.1fr;
            gap: 12px;
        }
        .card {
            background: #11111a;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            border: 1px solid #25253a;
        }
        .card h2 {
            font-size: 16px;
            margin-bottom: 4px;
        }
        .card small {
            font-size: 11px;
            color: #bbbbbb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        th, td {
            padding: 6px 6px;
            border-bottom: 1px solid #25253a;
            text-align: left;
        }
        th {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #bbbbbb;
        }

        .status-ativo { color: #ffb347; font-weight: bold; }
        .status-resolvido { color: #6be8a5; font-weight: bold; }

        .btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .btn {
            border-radius: 999px;
            border: none;
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }
        .btn-main {
            background: linear-gradient(135deg, #ff8800, #ffb347);
            color: #111;
            font-weight: 600;
        }
        .btn-main:hover { filter: brightness(0.95); }
        .btn-secondary {
            background: #232336;
            color: #f5f5f5;
            font-weight: 500;
        }
        .btn-secondary:hover { background: #30304a; }
        .btn-danger {
            background: #b02020;
            color: #fff;
            font-weight: 600;
        }
        .btn-danger:hover { background: #d02828; }

        .tag-siren {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            margin-top: 8px;
        }
        .dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
        }
        .dot-on { background: #ff3b3b; box-shadow: 0 0 8px #ff3b3b; }
        .dot-off { background: #555; }

        @media (max-width: 900px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">

    <div class="header">
        <div class="logo-wrap">
            <!-- TROQUE O CAMINHO DA LOGO SE PRECISAR -->
            <img src="/static/img/logo_profsafe.png" alt="Logo PROF-SAFE 24">
        </div>
        <div class="title-block">
            <div class="title">Central de Monitoramento ‚Äì PROF-SAFE 24</div>
            <div class="subtitle">Visualiza√ß√£o em tempo real dos alertas enviados pelos professores.</div>
        </div>
        <span class="badge">Central</span>
    </div>

    <div class="grid">
        <!-- Lista de alertas -->
        <div class="card">
            <h2>Alertas recebidos</h2>
            <small>Atualiza√ß√£o autom√°tica a cada 1 segundo.</small>

            <table>
                <thead>
                <tr>
                    <th>#</th>
                    <th>Professor</th>
                    <th>Sala/Local</th>
                    <th>Descri√ß√£o</th>
                    <th>Data/Hora</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody id="alerts-body">
                <tr><td colspan="6">Carregando alertas...</td></tr>
                </tbody>
            </table>

            <div class="btn-row">
                <button class="btn btn-secondary" onclick="refreshStatus()">üîÑ Atualizar agora</button>
                <button class="btn btn-secondary" onclick="resolverPrimeiro()">‚úÖ Marcar 1¬∫ como resolvido</button>
                <button class="btn btn-danger" onclick="limparAlertas()">üßπ Limpar todos</button>
            </div>
        </div>

        <!-- Sirene + Relat√≥rio + Navega√ß√£o -->
        <div class="card">
            <h2>Sirene & Relat√≥rio</h2>
            <small>Controle da sirene local e gera√ß√£o do relat√≥rio.</small>

            <div class="tag-siren">
                <span id="siren-dot" class="dot dot-off"></span>
                <span id="siren-text">Sirene desligada</span>
            </div>

            <div class="btn-row" style="margin-top: 10px;">
                <button class="btn btn-main" onclick="sirenOn()">üö® Ligar sirene</button>
                <button class="btn btn-secondary" onclick="sirenMute()">üîá Silenciar</button>
                <button class="btn btn-secondary" onclick="sirenOff()">‚èª Desligar</button>
            </div>

            <div class="btn-row" style="margin-top: 12px;">
                <a class="btn btn-secondary" href="/report.pdf" target="_blank">
                    üìÑ Ver relat√≥rio em PDF
                </a>
                <a class="btn btn-secondary" href="/admin/escola">
                    üè´ Dados da escola
                </a>
                <a class="btn btn-secondary" href="/">
                    üè† Tela inicial
                </a>
            </div>
        </div>
    </div>
</div>

<audio id="sirenAudio">
    <!-- Coloque aqui seu √°udio real de sirene -->
    <source src="/static/sounds/siren.mp3" type="audio/mpeg">
</audio>

<script>
    let currentSiren = false;
    let currentMuted = false;

    async function refreshStatus() {
        try {
            const resp = await fetch("/api/status");
            const data = await resp.json();

            const body = document.getElementById("alerts-body");
            body.innerHTML = "";

            if (!data.alerts || data.alerts.length === 0) {
                body.innerHTML = '<tr><td colspan="6">Nenhum alerta no momento.</td></tr>';
            } else {
                data.alerts.forEach((a, idx) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${idx + 1}</td>
                        <td>${a.teacher || '-'}</td>
                        <td>${a.room || '-'}</td>
                        <td>${a.description || '-'}</td>
                        <td>${a.ts || '-'}</td>
                        <td class="${a.resolved ? 'status-resolvido' : 'status-ativo'}">
                            ${a.resolved ? 'Resolvido' : 'Ativo'}
                        </td>
                    `;
                    body.appendChild(tr);
                });
            }

            currentSiren = data.siren;
            currentMuted = data.muted;
            atualizarSireneVisual();
        } catch (e) {
            console.error("Erro ao atualizar status:", e);
        }
    }

    function atualizarSireneVisual() {
        const dot = document.getElementById("siren-dot");
        const text = document.getElementById("siren-text");
        const audio = document.getElementById("sirenAudio");

        if (currentSiren && !currentMuted) {
            dot.className = "dot dot-on";
            text.textContent = "Sirene ligada";
            if (audio && audio.paused) {
                audio.loop = true;
                audio.play().catch(() => {});
            }
        } else if (currentSiren && currentMuted) {
            dot.className = "dot dot-off";
            text.textContent = "Sirene em modo silencioso";
            if (audio && !audio.paused) audio.pause();
        } else {
            dot.className = "dot dot-off";
            text.textContent = "Sirene desligada";
            if (audio && !audio.paused) audio.pause();
        }
    }

    async function sirenOn() {
        await fetch("/api/siren", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({action: "on"})
        });
        refreshStatus();
    }

    async function sirenOff() {
        await fetch("/api/siren", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({action: "off"})
        });
        refreshStatus();
    }

    async function sirenMute() {
        await fetch("/api/siren", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({action: "mute"})
        });
        refreshStatus();
    }

    async function resolverPrimeiro() {
        await fetch("/api/resolve", {method: "POST"});
        refreshStatus();
    }

    async function limparAlertas() {
        if (!confirm("Tem certeza que deseja limpar TODOS os alertas?")) return;
        await fetch("/api/clear", {method: "POST"});
        refreshStatus();
    }

    setInterval(refreshStatus, 1000);
    window.addEventListener("load", refreshStatus);
</script>
</body>
</html>
