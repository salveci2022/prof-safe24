
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PROF-SAFE 24 ‚Äì Professor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg">
<div class="container">
    <div class="top-bar">
        <div class="logo-area">
            <img src="{{ url_for('static', filename='logo_prof_safe24.png') }}" alt="PROF-SAFE 24" class="logo-rounded">
        </div>
        <div class="top-info">
            <h1 class="titulo">PROF-SAFE 24 ‚Äì App do Professor</h1>
            <p class="subtitulo">
                Envie um alerta r√°pido para a Central em qualquer situa√ß√£o de risco.
            </p>
            <p class="escola-nome">
                Escola: <strong id="nome-escola-topo">{{ escola.nome or "n√£o configurada" }}</strong>
            </p>
        </div>
        <div class="top-status">
            <span class="badge-online">Conectado √† Central</span>
        </div>
    </div>

    <div class="card card-form">
        <form id="form-alerta" onsubmit="enviarAlerta(event)">
            <div class="grupo">
                <label>Seu nome (opcional)</label>
                <input type="text" id="professor" placeholder="Ex: Prof. Ana, Prof. Jo√£o">
            </div>

            <div class="grupo">
                <label>Sala / Local</label>
                <input type="text" id="sala" placeholder="Ex: 5¬∫ A, P√°tio, Corredor 2" required>
            </div>

            <div class="grupo">
                <label>Tipo de ocorr√™ncia</label>
                <select id="tipo">
                    <option>Conflito/Briga</option>
                    <option>Problema de sa√∫de</option>
                    <option>Pessoa suspeita</option>
                    <option>Outra situa√ß√£o</option>
                </select>
            </div>

            <div class="grupo">
                <label>N√≠vel de urg√™ncia</label>
                <div class="urgencias">
                    <button type="button" class="btn-urg" data-urg="Baixa" onclick="selecionarUrgencia(this)">Baixa</button>
                    <button type="button" class="btn-urg ativo" data-urg="M√©dia" onclick="selecionarUrgencia(this)">M√©dia</button>
                    <button type="button" class="btn-urg" data-urg="Alta" onclick="selecionarUrgencia(this)">Alta</button>
                </div>
            </div>

            <div class="grupo">
                <label>Descreva rapidamente o que est√° acontecendo</label>
                <textarea id="descricao" rows="3" placeholder="Ex: briga entre alunos, aluno passando mal, pessoa suspeita no port√£o..."></textarea>
            </div>

            <div class="grupo">
                <button type="submit" class="btn btn-laranja btn-full">
                    üîî ENVIAR ALERTA PARA A CENTRAL
                </button>
            </div>

            <div class="botoes-acao">
                <button type="button" class="btn-link" onclick="reiniciarFormulario()">‚ü≥ Reiniciar</button>
                <button type="button" class="btn-link" onclick="limparCampos()">üßπ Limpar</button>
                <a href="{{ url_for('index') }}" class="btn-link">‚èª Sair</a>
            </div>

            <p class="dica">
                Dica: mantenha este atalho salvo na tela inicial do seu celular para acesso mais r√°pido.
                Os dados da escola s√£o configurados na Central; o professor apenas escolhe sala e envia alerta.
            </p>

            <p id="msg-resultado" class="msg-resultado"></p>
        </form>
    </div>
</div>

<script>
let urgenciaSelecionada = "M√©dia";

function selecionarUrgencia(botao) {
    document.querySelectorAll('.btn-urg').forEach(b => b.classList.remove('ativo'));
    botao.classList.add('ativo');
    urgenciaSelecionada = botao.getAttribute('data-urg');
}

function limparCampos() {
    document.getElementById('professor').value = "";
    document.getElementById('sala').value = "";
    document.getElementById('tipo').selectedIndex = 0;
    document.getElementById('descricao').value = "";
    document.getElementById('msg-resultado').textContent = "";
}

function reiniciarFormulario() {
    limparCampos();
    urgenciaSelecionada = "M√©dia";
    document.querySelectorAll('.btn-urg').forEach(b => b.classList.remove('ativo'));
    document.querySelectorAll('.btn-urg')[1].classList.add('ativo');
}

async function enviarAlerta(event) {
    event.preventDefault();
    const professor = document.getElementById('professor').value;
    const sala = document.getElementById('sala').value;
    const tipo = document.getElementById('tipo').value;
    const descricao = document.getElementById('descricao').value;
    const msg = document.getElementById('msg-resultado');

    if (!sala) {
        msg.textContent = "Informe a sala/local antes de enviar o alerta.";
        msg.classList.add('erro');
        return;
    }

    msg.textContent = "Enviando alerta...";
    msg.classList.remove('erro');
    msg.classList.remove('ok');

    try {
        const resp = await fetch("/api/alerta", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                professor: professor,
                sala: sala,
                tipo: tipo,
                urgencia: urgenciaSelecionada,
                descricao: descricao
            })
        });
        if (!resp.ok) {
            throw new Error("Falha ao enviar alerta");
        }
        const data = await resp.json();
        if (data.status === "ok") {
            msg.textContent = "Alerta enviado para a Central com sucesso!";
            msg.classList.add('ok');
        } else {
            msg.textContent = "N√£o foi poss√≠vel enviar o alerta. Verifique a conex√£o com a Central.";
            msg.classList.add('erro');
        }
    } catch (e) {
        msg.textContent = "N√£o foi poss√≠vel enviar o alerta. Verifique a conex√£o com a Central.";
        msg.classList.add('erro');
    }
}

// busca nome da escola para exibir no topo
async function carregarEscola() {
    try {
        const resp = await fetch("/api/escola");
        if (!resp.ok) return;
        const escola = await resp.json();
        if (escola && escola.nome) {
            document.getElementById("nome-escola-topo").textContent = escola.nome;
        }
    } catch (e) {}
}

carregarEscola();
</script>
</body>
</html>
