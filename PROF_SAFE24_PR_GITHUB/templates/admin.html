
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>PROF-SAFE 24 ‚Äì Painel Central</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg">
<div class="container">
    <div class="top-bar">
        <div class="logo-area">
            <img src="{{ url_for('static', filename='logo_prof_safe24.png') }}" alt="PROF-SAFE 24" class="logo-rounded">
        </div>
        <div class="top-info">
            <h1 class="titulo">PROF-SAFE 24 ‚Äì Painel Central</h1>
            <p class="subtitulo">Monitoramento em tempo real dos alertas enviados pelos professores.</p>
            <p class="escola-nome" id="escola-topo">
                {% if escola.nome %}
                    {{ escola.nome }} ‚Äì CNPJ: {{ escola.cnpj }} ‚Äì Contato: {{ escola.telefone }}
                {% else %}
                    Nenhuma escola configurada ainda.
                {% endif %}
            </p>
        </div>
        <div class="top-status">
            <span class="badge-online">‚óè Central Online</span>
            <div class="hora" id="hora-atual"></div>
        </div>
    </div>

    <div class="grid-central">
        <div class="card card-alertas">
            <h2>Alertas em tempo real</h2>
            <p class="legenda">Visualize os alertas enviados pelos professores, com hor√°rio, local e status.</p>

            <div id="lista-alertas-vazia" class="lista-vazia">
                Nenhum alerta registrado at√© o momento.
            </div>

            <table id="tabela-alertas" class="tabela-alertas oculto">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Professor</th>
                        <th>Sala/Local</th>
                        <th>Tipo</th>
                        <th>Urg√™ncia</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="botoes-acao linha">
                <button type="button" class="btn btn-azul" onclick="resolverPrimeiro()">Marcar primeiro alerta como resolvido</button>
                <button type="button" class="btn btn-cinza" onclick="limparAlertas()">Limpar todos os alertas</button>
            </div>

            <div class="botoes-acao linha">
                <a class="btn btn-verde" href="/relatorio.pdf" target="_blank">üìÑ Gerar relat√≥rio PDF</a>
                <a class="btn-link" href="{{ url_for('index') }}">‚èª Sair da Central</a>
            </div>

            <p class="dica">
                Recomenda-se manter a Central em tela cheia durante o per√≠odo letivo e definir um respons√°vel para atender os alertas.
            </p>
        </div>

        <div class="card card-escola-sirene">
            <h2>Dados da escola & Sirene</h2>

            <form id="form-escola" onsubmit="salvarEscola(event)">
                <div class="grupo">
                    <label>Nome da escola</label>
                    <input type="text" id="escola_nome" value="{{ escola.nome or '' }}" placeholder="Ex: Col√©gio Santa Maria">
                </div>
                <div class="grupo">
                    <label>CNPJ</label>
                    <input type="text" id="escola_cnpj" value="{{ escola.cnpj or '' }}" placeholder="CNPJ da escola">
                </div>
                <div class="grupo">
                    <label>Endere√ßo completo</label>
                    <input type="text" id="escola_endereco" value="{{ escola.endereco or '' }}" placeholder="Endere√ßo completo">
                </div>
                <div class="grupo">
                    <label>Telefone / WhatsApp</label>
                    <input type="text" id="escola_telefone" value="{{ escola.telefone or '' }}" placeholder="(00) 0000-0000">
                </div>

                <div class="botoes-acao linha">
                    <button type="submit" class="btn btn-verde">Salvar escola</button>
                    <button type="button" class="btn btn-cinza" onclick="limparEscola()">Limpar dados</button>
                </div>
            </form>

            <hr class="divisor">

            <h3>Controles da Sirene</h3>
            <p class="legenda">Use os bot√µes abaixo para controlar o aviso sonoro na Central.</p>

            <div class="botoes-acao linha">
                <button type="button" class="btn btn-laranja" onclick="ativarSomVisual()">üîä Ligar Sirene</button>
                <button type="button" class="btn btn-azul-claro" onclick="somenteVisual()">üîï Silenciar (sirene visual apenas)</button>
                <button type="button" class="btn btn-cinza" onclick="desligarSirene()">‚èπ Desligar Sirene</button>
            </div>

            <p class="legenda" id="modo-sirene-texto">
                Modo atual: {{ 'Som + Visual' if sirene_modo == 'som_visual' else 'Apenas visual' }}
            </p>

            <p class="dica">
                Mantenha a Central em local estrat√©gico, com o volume do computador em n√≠vel adequado.
            </p>
        </div>
    </div>
</div>

<audio id="audio-sirene" src="{{ url_for('sirene_file') }}" preload="auto" loop></audio>

<script>
let alertsCache = [];
let audioSirene = document.getElementById("audio-sirene");

function atualizarHora() {
    const agora = new Date();
    const h = String(agora.getHours()).padStart(2, '0');
    const m = String(agora.getMinutes()).padStart(2, '0');
    const s = String(agora.getSeconds()).padStart(2, '0');
    document.getElementById("hora-atual").textContent = h + ":" + m + ":" + s;
}
setInterval(atualizarHora, 1000);
atualizarHora();

async function carregarAlertas() {
    try {
        const resp = await fetch("/api/alertas");
        if (!resp.ok) return;
        const dados = await resp.json();
        alertsCache = dados;
        renderizarAlertas();
    } catch (e) {
        // sil√™ncio
    }
}

function renderizarAlertas() {
    const tabela = document.getElementById("tabela-alertas");
    const corpo = tabela.querySelector("tbody");
    const vazio = document.getElementById("lista-alertas-vazia");

    corpo.innerHTML = "";

    if (!alertsCache || alertsCache.length === 0) {
        tabela.classList.add("oculto");
        vazio.classList.remove("oculto");
        pararAudio();
        return;
    }

    vazio.classList.add("oculto");
    tabela.classList.remove("oculto");

    alertsCache.forEach(alerta => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${alerta.datahora}</td>
            <td>${alerta.professor}</td>
            <td>${alerta.sala}</td>
            <td>${alerta.tipo}</td>
            <td>${alerta.urgencia}</td>
            <td>${alerta.status}</td>
        `;
        if (alerta.status === "Ativo") {
            tr.classList.add("alerta-ativo");
        }
        corpo.appendChild(tr);
    });

    const temAtivo = alertsCache.some(a => a.status === "Ativo");
    if (temAtivo) {
        tocarAudioSeHabilitado();
    } else {
        pararAudio();
    }
}

async function resolverPrimeiro() {
    try {
        await fetch("/api/alertas/resolver_primeiro", {method: "POST"});
        await carregarAlertas();
    } catch (e) {}
}

async function limparAlertas() {
    if (!confirm("Tem certeza que deseja limpar todos os alertas?")) return;
    try {
        await fetch("/api/alertas/limpar", {method: "POST"});
        await carregarAlertas();
    } catch (e) {}
}

async function salvarEscola(event) {
    event.preventDefault();
    const nome = document.getElementById("escola_nome").value;
    const cnpj = document.getElementById("escola_cnpj").value;
    const endereco = document.getElementById("escola_endereco").value;
    const telefone = document.getElementById("escola_telefone").value;

    try {
        const resp = await fetch("/api/escola", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({nome, cnpj, endereco, telefone})
        });
        if (resp.ok) {
            document.getElementById("escola-topo").textContent =
                nome + " ‚Äì CNPJ: " + cnpj + " ‚Äì Contato: " + telefone;
            alert("Dados da escola salvos com sucesso.");
        }
    } catch (e) {}
}

function limparEscola() {
    document.getElementById("escola_nome").value = "";
    document.getElementById("escola_cnpj").value = "";
    document.getElementById("escola_endereco").value = "";
    document.getElementById("escola_telefone").value = "";
    document.getElementById("escola-topo").textContent = "Nenhuma escola configurada ainda.";
}

async function atualizarModoSirene(modo) {
    try {
        const resp = await fetch("/api/sirene_modo", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({modo})
        });
        if (resp.ok) {
            const data = await resp.json();
            const texto = data.modo_atual === "som_visual" ? "Som + Visual" : "Apenas visual";
            document.getElementById("modo-sirene-texto").textContent = "Modo atual: " + texto;
        }
    } catch (e) {}
}

function tocarAudioSeHabilitado() {
    fetch("/api/sirene_modo")
        .then(r => r.json())
        .then(data => {
            if (data.modo_atual === "som_visual") {
                audioSirene.play().catch(() => {
                    // navegador pode bloquear at√© ter intera√ß√£o humana
                });
            } else {
                pararAudio();
            }
        })
        .catch(() => {});
}

function pararAudio() {
    try {
        audioSirene.pause();
        audioSirene.currentTime = 0;
    } catch (e) {}
}

function ativarSomVisual() {
    atualizarModoSirene("som_visual");
    tocarAudioSeHabilitado();
}

function somenteVisual() {
    atualizarModoSirene("visual");
    pararAudio();
}

function desligarSirene() {
    atualizarModoSirene("visual");
    pararAudio();
}

setInterval(carregarAlertas, 4000);
carregarAlertas();
</script>
</body>
</html>
